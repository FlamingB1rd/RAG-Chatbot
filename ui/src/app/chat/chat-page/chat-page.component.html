<div class="chat-container">
  <!-- Sidebar -->
  <div class="conversations-sidebar" [class.open]="sidebarOpen">
    <div class="sidebar-header">
      <h3>Разговори</h3>
      <button mat-icon-button (click)="toggleSidebar()" class="toggle-button">
        <mat-icon>chevron_left</mat-icon>
      </button>
    </div>
    <button mat-flat-button 
            color="primary" 
            class="new-conversation-button"
            (click)="startNewConversation()">
      <mat-icon>add</mat-icon>
      <span>Нов разговор</span>
    </button>
    <div class="conversations-list">
      @if (conversationsLoading) {
        <div class="loading-conversations">
          <mat-progress-spinner mode="indeterminate" diameter="24"></mat-progress-spinner>
        </div>
      } @else if (conversations.length === 0) {
        <div class="empty-conversations">
          <p>Няма разговори</p>
        </div>
      } @else {
        @for (conv of conversations; track conv.id) {
          <div class="conversation-item" 
               [class.active]="currentConversationId === conv.id"
               (click)="loadConversation(conv.id)">
            <div class="conversation-content">
              <mat-icon class="conversation-icon">chat_bubble_outline</mat-icon>
              <span class="conversation-title">{{ conv.title }}</span>
            </div>
            <button mat-icon-button 
                    class="delete-conversation-button"
                    (click)="deleteConversation(conv.id, $event)"
                    matTooltip="Изтрий">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        }
      }
    </div>
  </div>

  <!-- Main Chat Area -->
  <div class="chat-main">
    <div class="chat-window" [class.has-messages]="messages.length > 0">
      @if (messages.length === 0) {
        <div class="empty-state">
          <div class="mascot-container">
            <img src="/assets/mascot.svg" alt="Techno Mascot" class="mascot-image">
          </div>
          <div class="empty-text">Какво искаш да попиташ?</div>
        </div>
      } @else {
        @for (m of messages; track m.id) {
          <div class="row" [class.row-me]="m.role==='user'">
            <div class="avatar" [class.me]="m.role==='user'">
              @if (m.role==='assistant') {
                <img src="/assets/mascot.svg" alt="Techno" class="avatar-mascot">
              } @else {
                <mat-icon>person</mat-icon>
              }
            </div>

            <div class="msg">
              <div class="meta">
                <span class="who" [class.me]="m.role==='user'">
                  {{ m.role === 'user' ? 'Потребител' : 'Асистент' }}
                </span>
                <span class="time">{{ m.timeStamp | date:'shortTime' }}</span>
              </div>

              <div class="bubble" [class.me]="m.role==='user'">
                @if (m.role === 'assistant') {
                  <markdown [data]="m.text"></markdown>
                } @else {
                  {{ m.text }}
                }
              </div>
            </div>
          </div>
        }
      }
      <div #bottom></div>
    </div>

    <!-- typing indicator -->
    @if (loading) {
      <div class="chat-status">
        AI chatbot is responding…
      </div>
    }

    <!-- composer -->
    <div class="composer" [class.empty-state]="messages.length === 0">
      <div class="composer-inner">
        <mat-form-field class="input" appearance="outline">
          <textarea matInput
                    rows="1"
                    [(ngModel)]="input"
                    (keydown)="onEnter($event)"
                    (input)="onInput($event)"
                    [disabled]="loading"
                    placeholder="Напиши въпрос…"></textarea>
        </mat-form-field>

        <button mat-icon-button
                color="primary"
                class="send"
                (click)="onSend()"
                [disabled]="loading || !input.trim()">
          <mat-icon>send</mat-icon>
        </button>
      </div>
    </div>
  </div>

  <!-- Sidebar Toggle Button (when closed) -->
  @if (!sidebarOpen) {
    <button mat-fab 
            color="primary" 
            class="sidebar-toggle-button"
            (click)="toggleSidebar()">
      <mat-icon>menu</mat-icon>
    </button>
  }
</div>

